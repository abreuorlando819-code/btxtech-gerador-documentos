<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BTXTech | Cl√≠nico PWA</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#020617" />

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- jsPDF + AutoTable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.4/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --bg:#020617;
      --card:#0b1224;
      --card2:#0a1020;
      --stroke:#13203d;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --blue:#1d4ed8;
      --cyan:#22d3ee;
      --green:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --r: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
      background: radial-gradient(1200px 600px at 30% 0%, rgba(29,78,216,.25), transparent 55%),
                  radial-gradient(900px 500px at 85% 10%, rgba(34,211,238,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    header{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      margin:8px 0 14px;
    }
    .brand{
      display:flex;align-items:center;gap:12px;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(29,78,216,1), rgba(34,211,238,1));
      box-shadow: var(--shadow);
      position:relative;
    }
    .logo:after{
      content:"";position:absolute;inset:10px;
      border-radius:10px;background: rgba(2,6,23,.35);
      border:1px solid rgba(255,255,255,.12);
    }
    .title{font-weight:800;letter-spacing:.2px}
    .subtitle{color:var(--muted);font-size:.9rem;margin-top:2px}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    button, .btn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;border-radius:12px;
      cursor:pointer; font-weight:700;
      transition:.15s transform, .15s background, .15s border;
    }
    button:hover, .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.09)}
    .btn-blue{background:rgba(29,78,216,.25);border-color:rgba(29,78,216,.55)}
    .btn-green{background:rgba(34,197,94,.18);border-color:rgba(34,197,94,.45)}
    .btn-danger{background:rgba(239,68,68,.16);border-color:rgba(239,68,68,.45)}
    .btn-cyan{background:rgba(34,211,238,.18);border-color:rgba(34,211,238,.45)}
    .grid{
      display:grid;gap:14px;
      grid-template-columns: 360px 1fr;
      align-items:start;
    }
    @media(max-width:980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(11,18,36,.98), rgba(10,16,32,.98));
      border:1px solid rgba(19,32,61,.9);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
    }
    .card .hd h2{
      margin:0;font-size:1.05rem
    }
    .card .bd{padding:14px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      font-size:.82rem;color:var(--muted);
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      white-space:nowrap;
    }
    label{display:block;font-size:.86rem;color:var(--muted);margin:10px 0 6px}
    input, textarea, select{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(2,6,23,.35);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:92px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:560px){.row{grid-template-columns:1fr}}
    .muted{color:var(--muted)}
    .sep{height:1px;background:rgba(255,255,255,.06);margin:12px 0}
    .tabs{display:flex;gap:10px;flex-wrap:wrap}
    .tab{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.05);cursor:pointer;font-weight:800}
    .tab.active{background:rgba(29,78,216,.25);border-color:rgba(29,78,216,.55)}
    .hide{display:none !important}
    .toast{
      position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
      background: rgba(10,16,32,.95);
      border:1px solid rgba(255,255,255,.12);
      padding:10px 12px; border-radius:12px;
      box-shadow: var(--shadow);
      max-width:92vw;
      opacity:0; pointer-events:none;
      transition:.2s opacity, .2s transform;
    }
    .toast.show{opacity:1; pointer-events:auto; transform:translateX(-50%) translateY(-2px)}
    .list{
      display:flex;flex-direction:column;gap:10px;
    }
    .mini{
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .budget-line{
      display:grid;grid-template-columns: 1fr 90px 110px 44px; gap:8px; align-items:center;
    }
    .budget-line input{padding:10px 10px}
    .iconbtn{
      width:44px;height:44px;border-radius:12px;
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      cursor:pointer;font-weight:900;
    }
    .small{font-size:.86rem}
    .dangerText{color:#fecaca}
    .okText{color:#bbf7d0}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      font-weight:800;font-size:.82rem;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(34,197,94,.45);
      background: rgba(34,197,94,.16);
    }
    .topnote{
      border:1px solid rgba(34,211,238,.35);
      background: rgba(34,211,238,.08);
      border-radius:16px;
      padding:12px 12px;
      color: var(--text);
    }

    /* Login overlay */
    .overlay{
      position:fixed;inset:0;
      background: rgba(2,6,23,.82);
      display:flex;align-items:center;justify-content:center;
      padding:16px; z-index:50;
    }
    .login{
      width:min(520px, 96vw);
    }
    .login .bd{padding:16px}
    .pinrow{display:flex;gap:10px}
    .pinrow input{font-size:1.1rem;letter-spacing:4px;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="title">BTXTech ‚Ä¢ Cl√≠nico PWA</div>
          <div class="subtitle">Ficha ‚Ä¢ Receitu√°rio ‚Ä¢ Or√ßamento ‚Ä¢ Laudos ‚Ä¢ PDF + Compartilhar</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn btn-cyan" id="btnBackup">Backup</button>
        <button class="btn" id="btnImport">Importar</button>
        <button class="btn btn-blue" id="btnPDF">Gerar PDF</button>
        <button class="btn btn-green" id="btnShare">Compartilhar</button>
        <button class="btn btn-danger" id="btnLogout">Bloquear</button>
      </div>
    </header>

    <div class="grid">
      <!-- Painel paciente -->
      <section class="card">
        <div class="hd">
          <h2>Paciente</h2>
          <span class="pill" id="statusSave">Salvo localmente</span>
        </div>
        <div class="bd">
          <div class="topnote small">
            <b>Dica:</b> tudo √© salvo automaticamente no dispositivo. Use <b>Backup</b> para exportar um arquivo e guardar.
          </div>

          <label>Nome do paciente</label>
          <input id="p_nome" placeholder="Ex.: Jo√£o brasileiro abaetetuba Para" />

          <div class="row">
            <div>
              <label>Data de nascimento</label>
              <input id="p_nasc" type="date" />
            </div>
            <div>
              <label>Telefone</label>
              <input id="p_tel" inputmode="tel" placeholder="(xx) xxxxx-xxxx" />
            </div>
          </div>

          <label>Endere√ßo</label>
          <input id="p_end" placeholder="Rua, n√∫mero, bairro, cidade" />

          <label>Motivo da consulta</label>
          <input id="p_motivo" placeholder="Queixa principal / demanda" />

          <div class="sep"></div>

          <label>Profissional / Cl√≠nica (aparece no PDF)</label>
          <input id="prof_nome" placeholder="Nome do profissional ou cl√≠nica" />

          <div class="row">
            <div>
              <label>Conselho / Registro (opcional)</label>
              <input id="prof_reg" placeholder="CRO/CRM/CRFa/..." />
            </div>
            <div>
              <label>Contato profissional (opcional)</label>
              <input id="prof_contato" placeholder="Telefone / e-mail / instagram" />
            </div>
          </div>

          <label>Endere√ßo profissional (opcional)</label>
          <input id="prof_end" placeholder="Endere√ßo da cl√≠nica" />

          <div class="sep"></div>

          <div class="row">
            <button class="btn" id="btnNewCase">Novo atendimento (limpar)</button>
            <button class="btn btn-danger" id="btnEraseAll">Apagar tudo (perigoso)</button>
          </div>

          <p class="muted small" style="margin:10px 0 0">
            * ‚ÄúApagar tudo‚Äù remove dados do dispositivo. Fa√ßa backup antes.
          </p>
        </div>
      </section>

      <!-- Conte√∫do -->
      <section class="card">
        <div class="hd">
          <h2>Atendimento</h2>
          <span class="badge" id="todayBadge">Hoje</span>
        </div>
        <div class="bd">
          <div class="tabs">
            <div class="tab active" data-tab="tab_ficha">Ficha</div>
            <div class="tab" data-tab="tab_receita">Receitu√°rio</div>
            <div class="tab" data-tab="tab_orc">Or√ßamento</div>
            <div class="tab" data-tab="tab_laudos">Laudos</div>
          </div>

          <!-- FICHA -->
          <div id="tab_ficha" class="tabpane" style="margin-top:12px">
            <label>Anamnese</label>
            <textarea id="a_anamnese" placeholder="Hist√≥ria, condi√ß√µes, alergias, medica√ß√µes em uso, etc."></textarea>

            <div class="row">
              <div>
                <label>Procedimento realizado (hoje)</label>
                <textarea id="a_realizado" placeholder="O que foi feito nesta consulta"></textarea>
              </div>
              <div>
                <label>Procedimentos planejados</label>
                <textarea id="a_planejado" placeholder="Conduta / pr√≥ximos passos / planejamento"></textarea>
              </div>
            </div>

            <label>Observa√ß√µes / Exame</label>
            <textarea id="a_obs" placeholder="Achados cl√≠nicos, exame f√≠sico, detalhes adicionais"></textarea>
          </div>

          <!-- RECEITU√ÅRIO -->
          <div id="tab_receita" class="tabpane hide" style="margin-top:12px">
            <div class="row">
              <div>
                <label>Selecionar medica√ß√£o pronta</label>
                <select id="rx_preset">
                  <option value="">‚Äî Escolher ‚Äî</option>
                </select>
              </div>
              <div>
                <label>&nbsp;</label>
                <button class="btn btn-cyan" id="btnAddPreset">Adicionar √† receita</button>
              </div>
            </div>

            <label>Receita</label>
            <textarea id="rx_texto" placeholder="Escreva a prescri√ß√£o aqui..."></textarea>

            <div class="row">
              <button class="btn" id="btnRxClear">Limpar receita</button>
              <button class="btn btn-green" id="btnRxInsertDate">Inserir data/assinatura</button>
            </div>

            <p class="muted small" style="margin:10px 0 0">
              Voc√™ pode editar livremente o texto ap√≥s inserir uma medica√ß√£o pronta.
            </p>
          </div>

          <!-- OR√áAMENTO -->
          <div id="tab_orc" class="tabpane hide" style="margin-top:12px">
            <div class="row">
              <div>
                <label>Data do or√ßamento</label>
                <input id="orc_data" type="date"/>
              </div>
              <div>
                <label>Validade (dias)</label>
                <input id="orc_validade" type="number" min="0" placeholder="Ex.: 7" />
              </div>
            </div>

            <div class="sep"></div>

            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
              <div class="pill">Itens ilimitados ‚Ä¢ clique ‚Äú+ Adicionar item‚Äù</div>
              <button class="btn btn-cyan" id="btnAddItem">+ Adicionar item</button>
            </div>

            <div class="sep"></div>

            <div id="budgetList" class="list"></div>

            <div class="sep"></div>

            <div class="row">
              <div class="mini">
                <div class="muted small">Total (R$)</div>
                <div style="font-size:1.4rem;font-weight:900" id="orc_total">0,00</div>
              </div>
              <div class="mini">
                <div class="muted small">Observa√ß√µes do or√ßamento</div>
                <input id="orc_obs" placeholder="Ex.: formas de pagamento, condi√ß√µes..." />
              </div>
            </div>
          </div>

          <!-- LAUDOS -->
          <div id="tab_laudos" class="tabpane hide" style="margin-top:12px">
            <label>T√≠tulo do laudo</label>
            <input id="ld_titulo" placeholder="Ex.: Laudo cl√≠nico" />

            <label>Texto do laudo</label>
            <textarea id="ld_texto" placeholder="Descreva o laudo aqui..."></textarea>

            <div class="row">
              <button class="btn" id="btnLdClear">Limpar laudo</button>
              <button class="btn btn-green" id="btnLdInsertDate">Inserir data/assinatura</button>
            </div>

            <p class="muted small" style="margin:10px 0 0">
              O laudo vai junto no PDF final.
            </p>
          </div>

        </div>
      </section>
    </div>
  </div>

  <!-- LOGIN OVERLAY -->
  <div class="overlay" id="loginOverlay">
    <div class="card login">
      <div class="hd">
        <h2>Acesso (PIN)</h2>
        <span class="pill" id="loginModePill">Configurar</span>
      </div>
      <div class="bd">
        <p class="muted" style="margin:0 0 10px">
          Primeiro acesso: crie um PIN (4 a 6 d√≠gitos). Depois, use esse PIN para desbloquear.
        </p>

        <div class="pinrow">
          <input id="pinInput" inputmode="numeric" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="6" />
          <button class="btn btn-blue" id="btnPinGo">Entrar</button>
        </div>

        <div class="sep"></div>

        <div class="row">
          <button class="btn" id="btnResetPin">Esqueci o PIN</button>
          <button class="btn btn-danger" id="btnLock">Bloquear</button>
        </div>

        <p class="muted small" style="margin:10px 0 0">
          ‚ÄúEsqueci o PIN‚Äù apaga apenas o PIN (n√£o apaga os dados). Para apagar tudo, use ‚ÄúApagar tudo‚Äù no painel do paciente.
        </p>

        <div class="sep"></div>

        <div class="mini">
          <div style="font-weight:900">Mini bio (voc√™ pode editar no PDF)</div>
          <div class="muted small" style="margin-top:6px">
            Cirurgi√£o-dentista (2010) ‚Ä¢ Bucomaxilo ‚Ä¢ P√≥s em Sa√∫de Coletiva ‚Ä¢ Graduando em Medicina e ADS ‚Ä¢
            Fundador de startup de bioengenharia na regi√£o.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* =========================
   UTIL
========================= */
const $ = (id)=>document.getElementById(id);
const toast = (msg, ok=true)=>{
  const t = $("toast");
  t.textContent = msg;
  t.style.borderColor = ok ? "rgba(34,197,94,.45)" : "rgba(239,68,68,.45)";
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 2200);
};
const fmtMoney = (n)=>{
  const v = Number(n||0);
  return v.toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2});
};
const todayISO = ()=>{
  const d = new Date();
  const tz = d.getTimezoneOffset()*60000;
  return new Date(d - tz).toISOString().slice(0,10);
};
$("todayBadge").textContent = "Hoje ‚Ä¢ " + new Date().toLocaleDateString("pt-BR");

/* =========================
   STORAGE
========================= */
const KEY_DATA = "btx_clinico_data_v1";
const KEY_PIN  = "btx_pin_v1";
const KEY_LOCK = "btx_locked_v1";

const defaultData = ()=>({
  paciente:{
    nome:"", nasc:"", tel:"", end:"", motivo:""
  },
  profissional:{
    nome:"", reg:"", contato:"", end:""
  },
  atendimento:{
    anamnese:"", realizado:"", planejado:"", obs:""
  },
  receita:{
    texto:""
  },
  orcamento:{
    data: todayISO(),
    validade:"",
    obs:"",
    itens:[]
  },
  laudo:{
    titulo:"Laudo cl√≠nico",
    texto:""
  },
  meta:{
    updatedAt: Date.now()
  }
});

let data = defaultData();


  }
}
function saveData(){
  data.meta.updatedAt = Date.now();
  localStorage.setItem(KEY_DATA, JSON.stringify(data));
  $("statusSave").textContent = "Salvo ‚Ä¢ " + new Date(data.meta.updatedAt).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});
}
function bindInputs(){
  // paciente
  $("p_nome").value = data.paciente.nome||"";
  $("p_nasc").value = data.paciente.nasc||"";
  $("p_tel").value = data.paciente.tel||"";
  $("p_end").value = data.paciente.end||"";
  $("p_motivo").value = data.paciente.motivo||"";

  // prof
  $("prof_nome").value = data.profissional.nome||"";
  $("prof_reg").value = data.profissional.reg||"";
  $("prof_contato").value = data.profissional.contato||"";
  $("prof_end").value = data.profissional.end||"";

  // atendimento
  $("a_anamnese").value = data.atendimento.anamnese||"";
  $("a_realizado").value = data.atendimento.realizado||"";
  $("a_planejado").value = data.atendimento.planejado||"";
  $("a_obs").value = data.atendimento.obs||"";

  // receita
  $("rx_texto").value = data.receita.texto||"";

  // orc
  $("orc_data").value = data.orcamento.data || todayISO();
  $("orc_validade").value = data.orcamento.validade || "";
  $("orc_obs").value = data.orcamento.obs || "";
  renderBudget();

  // laudo
  $("ld_titulo").value = data.laudo.titulo||"Laudo cl√≠nico";
  $("ld_texto").value = data.laudo.texto||"";
}
function hookAutoSave(){
  const map = [
    ["p_nome", v=>data.paciente.nome=v],
    ["p_nasc", v=>data.paciente.nasc=v],
    ["p_tel", v=>data.paciente.tel=v],
    ["p_end", v=>data.paciente.end=v],
    ["p_motivo", v=>data.paciente.motivo=v],

    ["prof_nome", v=>data.profissional.nome=v],
    ["prof_reg", v=>data.profissional.reg=v],
    ["prof_contato", v=>data.profissional.contato=v],
    ["prof_end", v=>data.profissional.end=v],

    ["a_anamnese", v=>data.atendimento.anamnese=v],
    ["a_realizado", v=>data.atendimento.realizado=v],
    ["a_planejado", v=>data.atendimento.planejado=v],
    ["a_obs", v=>data.atendimento.obs=v],

    ["rx_texto", v=>data.receita.texto=v],

    ["orc_data", v=>data.orcamento.data=v],
    ["orc_validade", v=>data.orcamento.validade=v],
    ["orc_obs", v=>data.orcamento.obs=v],

    ["ld_titulo", v=>data.laudo.titulo=v],
    ["ld_texto", v=>data.laudo.texto=v],
  ];

  map.forEach(([id,setter])=>{
    $(id).addEventListener("input", ()=>{
      setter($(id).value);
      saveData();
      renderBudgetTotal();
    });
    $(id).addEventListener("change", ()=>{
      setter($(id).value);
      saveData();
      renderBudgetTotal();
    });
  });
}

/* =========================
   TABS
========================= */
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    const target = t.dataset.tab;
    document.querySelectorAll(".tabpane").forEach(p=>p.classList.add("hide"));
    $(target).classList.remove("hide");
  });
});

/* =========================
   RECEITU√ÅRIO PRESETS
========================= */
const presets = [
  {k:"Paracetamol 750 mg", v:"Paracetamol 750 mg\nTomar 1 comprimido a cada 6‚Äì8 horas se dor ou febre, por at√© 3 dias.\n\n"},
  {k:"Dipirona 500 mg", v:"Dipirona 500 mg\nTomar 1 comprimido a cada 6 horas se dor ou febre, por at√© 3 dias.\n\n"},
  {k:"Ibuprofeno 400 mg", v:"Ibuprofeno 400 mg\nTomar 1 comprimido a cada 8 horas ap√≥s alimenta√ß√£o, por at√© 3 dias.\n\n"},
  {k:"Diclofenaco de pot√°ssio 50 mg", v:"Diclofenaco de pot√°ssio 50 mg\nTomar 1 comprimido a cada 8‚Äì12 horas ap√≥s alimenta√ß√£o, por at√© 3 dias.\n\n"},
  {k:"Amoxicilina 500 mg", v:"Amoxicilina 500 mg\nTomar 1 c√°psula a cada 8 horas por 7 dias.\n\n"},
  {k:"Amoxicilina + Clavulanato 875/125 mg", v:"Amoxicilina + Clavulanato 875/125 mg\nTomar 1 comprimido a cada 12 horas por 7 dias.\n\n"},
  {k:"Azitromicina 500 mg", v:"Azitromicina 500 mg\nTomar 1 comprimido 1x ao dia por 3 dias.\n\n"},
];

function loadPresets(){
  const sel = $("rx_preset");
  presets.forEach(p=>{
    const o = document.createElement("option");
    o.value = p.v;
    o.textContent = p.k;
    sel.appendChild(o);
  });
}
$("btnAddPreset").addEventListener("click", ()=>{
  const val = $("rx_preset").value;
  if(!val){ toast("Escolha uma medica√ß√£o", false); return; }
  $("rx_texto").value = ($("rx_texto").value || "") + val;
  data.receita.texto = $("rx_texto").value;
  saveData();
  toast("Medica√ß√£o adicionada");
});
$("btnRxClear").addEventListener("click", ()=>{
  $("rx_texto").value = "";
  data.receita.texto = "";
  saveData();
  toast("Receita limpa");
});
$("btnRxInsertDate").addEventListener("click", ()=>{
  const d = new Date().toLocaleDateString("pt-BR");
  const s = `\n\nData: ${d}\nAssinatura: __________________________\n`;
  $("rx_texto").value = ($("rx_texto").value||"") + s;
  data.receita.texto = $("rx_texto").value;
  saveData();
  toast("Inserido");
});

/* =========================
   OR√áAMENTO (itens ilimitados)
========================= */
function addBudgetItem(item={desc:"", qtd:1, valor:0}){
  data.orcamento.itens.push(item);
  saveData();
  renderBudget();
  toast("Item adicionado");
}
function removeBudgetItem(idx){
  data.orcamento.itens.splice(idx,1);
  saveData();
  renderBudget();
  toast("Item removido");
}
function renderBudget(){
  const box = $("budgetList");
  box.innerHTML = "";
  if(data.orcamento.itens.length === 0){
    const empty = document.createElement("div");
    empty.className="mini muted";
    empty.textContent = "Nenhum item no or√ßamento ainda.";
    box.appendChild(empty);
    renderBudgetTotal();
    return;
  }
  data.orcamento.itens.forEach((it, idx)=>{
    const div = document.createElement("div");
    div.className="mini";
    div.innerHTML = `
      <div class="budget-line">
        <input data-k="desc" placeholder="Descri√ß√£o do item" value="${escapeHtml(it.desc||"")}" />
        <input data-k="qtd" type="number" min="1" placeholder="Qtd" value="${Number(it.qtd||1)}" />
        <input data-k="valor" type="number" min="0" step="0.01" placeholder="Valor" value="${Number(it.valor||0)}" />
        <div class="iconbtn" title="Remover">√ó</div>
      </div>
      <div class="muted small" style="margin-top:8px">
        Subtotal: <b>${fmtMoney((Number(it.qtd||1)*Number(it.valor||0)))}</b>
      </div>
    `;
    const inputs = div.querySelectorAll("input");
    inputs.forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const k = inp.dataset.k;
        let v = inp.value;
        if(k==="qtd") v = Math.max(1, parseInt(v||"1",10));
        if(k==="valor") v = Number(v||0);
        data.orcamento.itens[idx][k]=v;
        saveData();
        renderBudget();
      });
    });
    div.querySelector(".iconbtn").addEventListener("click", ()=>removeBudgetItem(idx));
    box.appendChild(div);
  });
  renderBudgetTotal();
}
function renderBudgetTotal(){
  let total = 0;
  (data.orcamento.itens||[]).forEach(it=>{
    total += (Number(it.qtd||1) * Number(it.valor||0));
  });
  $("orc_total").textContent = fmtMoney(total);
}
$("btnAddItem").addEventListener("click", ()=> addBudgetItem());

function escapeHtml(str){
  return String(str||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}

/* =========================
   LAUDOS
========================= */
$("btnLdClear").addEventListener("click", ()=>{
  $("ld_texto").value = "";
  data.laudo.texto = "";
  saveData();
  toast("Laudo limpo");
});
$("btnLdInsertDate").addEventListener("click", ()=>{
  const d = new Date().toLocaleDateString("pt-BR");
  const s = `\n\nData: ${d}\nAssinatura: __________________________\n`;
  $("ld_texto").value = ($("ld_texto").value||"") + s;
  data.laudo.texto = $("ld_texto").value;
  saveData();
  toast("Inserido");
});

/* =========================
   NOVO / APAGAR
========================= */
$("btnNewCase").addEventListener("click", ()=>{
  if(!confirm("Limpar atendimento atual? (n√£o apaga o PIN)")) return;
  const keepProf = data.profissional; // mant√©m profissional por praticidade
  data = defaultData();
  data.profissional = keepProf;
  saveData();
  bindInputs();
  toast("Novo atendimento pronto");
});
$("btnEraseAll").addEventListener("click", ()=>{
  if(!confirm("Isso vai apagar TODOS os dados do dispositivo. Tem certeza?")) return;
  localStorage.removeItem(KEY_DATA);
  data = defaultData();
  bindInputs();
  toast("Dados apagados", false);
});

/* =========================
   BACKUP / IMPORT
========================= */
$("btnBackup").addEventListener("click", ()=>{
  const payload = {
    exportedAt: new Date().toISOString(),
    app: "BTXTech Clinico PWA",
    version: 1,
    data
  };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `btx_backup_${(data.paciente.nome||"paciente").replaceAll(" ","_")}_${todayISO()}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast("Backup exportado");
});

$("btnImport").addEventListener("click", ()=>{
  const inp = document.createElement("input");
  inp.type="file";
  inp.accept="application/json";
  inp.onchange = async ()=>{
    const file = inp.files?.[0];
    if(!file) return;
    const text = await file.text();
    try{
      const json = JSON.parse(text);
      if(!json.data) throw new Error("Sem campo data");
      data = Object.assign(defaultData(), json.data);
      saveData();
      bindInputs();
      toast("Importado com sucesso");
    }catch(e){
      toast("Arquivo inv√°lido", false);
    }
  };
  inp.click();
});

/* =========================
   PDF
========================= */
function buildPdfficha(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:"mm", format:"a4"});
  const margin = 12;

  // Header
  doc.setFont("helvetica","bold");
  doc.setFontSize(16);
  doc.text("BTXTech ‚Ä¢ Documento Cl√≠nico", margin, 16);

  doc.setFont("helvetica","normal");
  doc.setFontSize(10);
  const profLine = [
    data.profissional.nome ? data.profissional.nome : "",
    data.profissional.reg ? ("Registro: " + data.profissional.reg) : "",
    data.profissional.contato ? data.profissional.contato : "",
    data.profissional.end ? data.profissional.end : ""
  ].filter(Boolean).join(" ‚Ä¢ ");
  if(profLine) doc.text(profLine, margin, 22);

  doc.setDrawColor(34,211,238);
  doc.setLineWidth(.4);
  doc.line(margin, 24, 210 - margin, 24);

  // Patient block
  doc.setFont("helvetica","bold");
  doc.setFontSize(12);
  doc.text("Paciente", margin, 32);
  doc.setFont("helvetica","normal");
  doc.setFontSize(10);

    // Garantir nome do paciente (n√£o some)
  const nomeFromData = (data?.paciente?.nome || "").trim();

  // Tente pegar do input da tela (troque o ID abaixo pelo ID real do seu input)
  const nomeFromInput = (document.getElementById("pacienteNome")?.value || "").trim();

  const nomePaciente = (nomeFromData || nomeFromInput || "-");
const pacienteRows = [
    ["Nome", nomePaciente],
    ["Nascimento", data.paciente.nasc ? new Date(data.paciente.nasc+"T00:00:00").toLocaleDateString("pt-BR") : "-"],
    ["Telefone", data.paciente.tel || "-"],
    ["Endere√ßo", data.paciente.end || "-"],
    ["Motivo da consulta", data.paciente.motivo || "-"],
  ];

  doc.autoTable({
    startY: 35,
    head: [["Campo","Informa√ß√£o"]],
    body: pacienteRows,
    styles:{fontSize:9, cellPadding:2},
    headStyles:{fillColor:[29,78,216]},
    theme:"grid",
    margin:{left:margin,right:margin}
  });

  let y = doc.lastAutoTable.finalY + 8;

  // Atendimento
  doc.setFont("helvetica","bold");
  doc.setFontSize(12);
  doc.text("Atendimento", margin, y);
  y += 4;

  const blocks = [
    ["Anamnese", data.atendimento.anamnese],
    ["Procedimento realizado (hoje)", data.atendimento.realizado],
    ["Procedimentos planejados", data.atendimento.planejado],
    ["Observa√ß√µes / Exame", data.atendimento.obs],
  ];

  doc.setFont("helvetica","normal");
  doc.setFontSize(10);
  blocks.forEach(([t, txt])=>{
    y += 6;
    doc.setFont("helvetica","bold"); doc.text(t, margin, y);
    y += 3;
    doc.setFont("helvetica","normal");
    const content = (txt||"-").trim() || "-";
    const lines = doc.splitTextToSize(content, 210 - margin*2);
    doc.text(lines, margin, y+4);
    y += (lines.length*4) + 6;
    if(y > 270){ doc.addPage(); y = 18; }
  });

  // Receita
  if((data.receita.texto||"").trim()){
    if(y > 240){ doc.addPage(); y = 18; }
    doc.setFont("helvetica","bold");
    doc.setFontSize(12);
    doc.text("Receitu√°rio", margin, y);
    y += 6;
    doc.setFont("helvetica","normal");
    doc.setFontSize(10);
    const rx = doc.splitTextToSize(data.receita.texto.trim(), 210 - margin*2);
    doc.text(rx, margin, y);
    y += rx.length*4 + 8;
  }

  // Or√ßamento
  if((data.orcamento.itens||[]).length){
    if(y > 220){ doc.addPage(); y = 18; }
    doc.setFont("helvetica","bold");
    doc.setFontSize(12);
    doc.text("Or√ßamento", margin, y);
    y += 4;

    const orcInfo = [
      ["Data", data.orcamento.data ? new Date(data.orcamento.data+"T00:00:00").toLocaleDateString("pt-BR") : "-"],
      ["Validade (dias)", data.orcamento.validade || "-"],
      ["Observa√ß√µes", data.orcamento.obs || "-"],
    ];
    doc.autoTable({
      startY: y+2,
      head: [["Campo","Informa√ß√£o"]],
      body: orcInfo,
      styles:{fontSize:9, cellPadding:2},
      headStyles:{fillColor:[34,211,238]},
      theme:"grid",
      margin:{left:margin,right:margin}
    });
    y = doc.lastAutoTable.finalY + 6;

    const items = data.orcamento.itens.map(it=>[
      it.desc||"-",
      String(it.qtd||1),
      fmtMoney(Number(it.valor||0)),
      fmtMoney(Number(it.qtd||1)*Number(it.valor||0))
    ]);

    doc.autoTable({
      startY: y,
      head: [["Item","Qtd","Valor (R$)","Subtotal (R$)"]],
      body: items,
      styles:{fontSize:9, cellPadding:2},
      headStyles:{fillColor:[29,78,216]},
      theme:"grid",
      margin:{left:margin,right:margin}
    });

    let total = 0;
    data.orcamento.itens.forEach(it=> total += Number(it.qtd||1)*Number(it.valor||0));
    y = doc.lastAutoTable.finalY + 8;

    doc.setFont("helvetica","bold");
    doc.setFontSize(12);
    doc.text("Total: R$ " + fmtMoney(total), margin, y);
    y += 6;
  }

  // Laudo
  if((data.laudo.texto||"").trim()){
    if(y > 240){ doc.addPage(); y = 18; }
    doc.setFont("helvetica","bold");
    doc.setFontSize(12);
    doc.text(data.laudo.titulo || "Laudo", margin, y);
    y += 6;
    doc.setFont("helvetica","normal");
    doc.setFontSize(10);
    const ld = doc.splitTextToSize(data.laudo.texto.trim(), 210 - margin*2);
    doc.text(ld, margin, y);
    y += ld.length*4 + 8;
  }

  // Rodap√©
  doc.setFont("helvetica","normal");
  doc.setFontSize(9);
  doc.setTextColor(150);
  doc.text("Gerado via BTXTech ‚Ä¢ PWA (offline)", margin, 292);

  return doc;
}

function pdfBlobAndName(){
  const doc = buildPdf();
  const blob = doc.output("blob");
  const safeName = (data.paciente.nome || "paciente").trim().replaceAll(/[\\/:*?"<>|]/g,"").replaceAll(" ","_");
  const fname = `BTXTech_${safeName}_${todayISO()}.pdf`;
  return {blob, fname};
}



$("btnShare").addEventListener("click", async ()=>{
  try{
    const {blob, fname} = pdfBlobAndName();
    const file = $("btnPDF").addEventListener("click", ()=>{

  // üî• FOR√áAR o nome que est√° na tela
  const nomeDigitado =
    (document.querySelector('input')?.value || "").trim();

  if (nomeDigitado) {
    data.paciente = data.paciente || {};
    data.paciente.nome = nomeDigitado;
  }

  const doc = buildPdfFicha();

  const safeName = (data.paciente.nome || "paciente")
    .trim()
    .replaceAll(/[\\/:*?"<>|]/g,"")
    .replaceAll(" ","_");

  doc.save(`BTXTech_${safeName}_${todayISO()}.pdf`);
  toast("PDF gerado");
});
new File([blob], fname, {type:"application/pdf"});
    if(navigator.share && navigator.canShare && navigator.canShare({files:[file]})){
      await navigator.share({title:"Documento Cl√≠nico", text:"PDF gerado no BTXTech", files:[file]});
      toast("Compartilhado");
      return;
    }
    // fallback download
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = fname; a.click();
    URL.revokeObjectURL(url);
    toast("Seu navegador n√£o suporta compartilhar ‚Ä¢ baixei o PDF");
  }catch(e){
    toast("Falha ao compartilhar", false);
  }
});

/* =========================
   LOGIN PIN (local)
========================= */
function isLocked(){
  return localStorage.getItem(KEY_LOCK)==="1";
}
function setLocked(v){
  localStorage.setItem(KEY_LOCK, v ? "1":"0");
}
function hasPin(){
  return !!localStorage.getItem(KEY_PIN);
}
function setPin(pin){
  localStorage.setItem(KEY_PIN, pin);
}
function checkPin(pin){
  return localStorage.getItem(KEY_PIN) === pin;
}
function showLogin(show){
  $("loginOverlay").style.display = show ? "flex" : "none";
}
function updateLoginMode(){
  $("loginModePill").textContent = hasPin() ? "Desbloquear" : "Configurar";
}
function lockNow(){
  setLocked(true);
  showLogin(true);
  updateLoginMode();
  $("pinInput").value="";
  $("pinInput").focus();
}
$("btnLogout").addEventListener("click", lockNow);
$("btnLock").addEventListener("click", lockNow);

$("btnResetPin").addEventListener("click", ()=>{
  if(!confirm("Isso vai remover o PIN do dispositivo. Voc√™ precisar√° criar outro. Continuar?")) return;
  localStorage.removeItem(KEY_PIN);
  updateLoginMode();
  toast("PIN removido. Crie um novo.");
});

$("btnPinGo").addEventListener("click", ()=>{
  const pin = ($("pinInput").value||"").trim();
  if(pin.length < 4 || pin.length > 6 || !/^\d+$/.test(pin)){
    toast("PIN deve ter 4 a 6 d√≠gitos", false); return;
  }
  if(!hasPin()){
    setPin(pin);
    setLocked(false);
    showLogin(false);
    toast("PIN criado. Bem-vindo!");
    return;
  }
  if(checkPin(pin)){
    setLocked(false);
    showLogin(false);
    toast("Desbloqueado");
  }else{
    toast("PIN incorreto", false);
  }
});

// Iniciar
function boot(){
  loadData();
  bindInputs();
  hookAutoSave();
  loadPresets();
  if(!data.orcamento.data) { data.orcamento.data = todayISO(); saveData(); }
  if(isLocked() || !hasPin()){
    showLogin(true);
    updateLoginMode();
    setLocked(true);
  }else{
    showLogin(false);
  }
}
boot();

/* =========================
   Service Worker
========================= */
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("./sw.js").catch(()=>{});
}
</script>
</body>
</html>
